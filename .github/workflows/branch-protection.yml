name: Branch Protection Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-branch-protection:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Check PR requirements
      run: |
        echo "ğŸ” éªŒè¯PRæ˜¯å¦æ»¡è¶³åˆ†æ”¯ä¿æŠ¤è¦æ±‚..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å¿…éœ€çš„æ ‡ç­¾
        if [[ "${{ github.event.pull_request.head.ref }}" =~ ^(feature|bugfix|hotfix|docs)/.+ ]]; then
          echo "âœ… åˆ†æ”¯å‘½åç¬¦åˆè§„èŒƒ: ${{ github.event.pull_request.head.ref }}"
        else
          echo "âš ï¸ å»ºè®®ä½¿ç”¨è§„èŒƒçš„åˆ†æ”¯å‘½å: feature/xxx, bugfix/xxx, hotfix/xxx, docs/xxx"
        fi
        
        # æ£€æŸ¥PRæè¿°
        if [[ -n "${{ github.event.pull_request.body }}" ]]; then
          echo "âœ… PRåŒ…å«æè¿°ä¿¡æ¯"
        else
          echo "âŒ PRç¼ºå°‘æè¿°ï¼Œè¯·æ·»åŠ å˜æ›´è¯´æ˜"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦é“¾æ¥äº†Issue (å¯é€‰)
        if [[ "${{ github.event.pull_request.body }}" =~ (close|closes|fix|fixes|resolve|resolves).*#[0-9]+ ]]; then
          echo "âœ… PRé“¾æ¥äº†ç›¸å…³Issue"
        else
          echo "â„¹ï¸ å»ºè®®åœ¨PRä¸­é“¾æ¥ç›¸å…³Issue"
        fi

  check-required-files:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate required files exist
      run: |
        echo "ğŸ“ æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
        
        required_files=(
          "README.md"
          "requirements.txt" 
          "pyproject.toml"
          ".github/workflows/ci.yml"
          ".github/CODEOWNERS"
          ".flake8"
          "pytest.ini"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
          fi
        done
        
        if [[ ${#missing_files[@]} -eq 0 ]]; then
          echo "âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å­˜åœ¨"
        else
          echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: ${missing_files[*]}"
          exit 1
        fi

  validate-codeowners:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate CODEOWNERS syntax
      run: |
        echo "ğŸ‘¥ éªŒè¯CODEOWNERSæ–‡ä»¶..."
        
        if [[ ! -f ".github/CODEOWNERS" ]]; then
          echo "âŒ CODEOWNERSæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥åŸºæœ¬è¯­æ³•
        while IFS= read -r line; do
          # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
          if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
            continue
          fi
          
          # æ£€æŸ¥è¡Œæ ¼å¼ (è·¯å¾„ + @ç”¨æˆ·å)
          if [[ ! "$line" =~ ^[^[:space:]]+[[:space:]]+@.+ ]]; then
            echo "âŒ CODEOWNERSè¯­æ³•é”™è¯¯: $line"
            exit 1
          fi
        done < .github/CODEOWNERS
        
        echo "âœ… CODEOWNERSè¯­æ³•æ­£ç¡®"

  security-baseline:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        pip install bandit safety
    
    - name: Quick security scan
      run: |
        echo "ğŸ”’ è¿è¡Œå¿«é€Ÿå®‰å…¨æ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„å®‰å…¨é—®é¢˜
        if bandit -r ai_town/ -f json | jq -e '.results | length > 0' > /dev/null 2>&1; then
          echo "âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†å®‰å…¨æŠ¥å‘Š"
          bandit -r ai_town/ -ll
        else
          echo "âœ… æœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜"
        fi
        
        # æ£€æŸ¥ä¾èµ–é¡¹
        if ! safety check --json > /dev/null 2>&1; then
          echo "âš ï¸ å‘ç°ä¾èµ–é¡¹å®‰å…¨é—®é¢˜ï¼Œè¯·æ›´æ–°ç›¸å…³åŒ…"
          safety check
        else
          echo "âœ… ä¾èµ–é¡¹å®‰å…¨æ£€æŸ¥é€šè¿‡"
        fi

  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check documentation updates
      run: |
        echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£æ˜¯å¦éœ€è¦æ›´æ–°..."
        
        # æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ ¸å¿ƒä»£ç ä½†æ²¡æœ‰æ›´æ–°æ–‡æ¡£
        changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")
        
        core_changed=false
        docs_changed=false
        
        for file in $changed_files; do
          if [[ "$file" =~ ^ai_town/(core|events|agents)/ ]]; then
            core_changed=true
          elif [[ "$file" =~ \.(md|rst|txt)$ ]] || [[ "$file" =~ ^docs/ ]]; then
            docs_changed=true
          fi
        done
        
        if [[ "$core_changed" == true && "$docs_changed" == false ]]; then
          echo "âš ï¸ æ ¸å¿ƒä»£ç æœ‰å˜æ›´ï¼Œå»ºè®®åŒæ—¶æ›´æ–°ç›¸å…³æ–‡æ¡£"
        else
          echo "âœ… æ–‡æ¡£æ£€æŸ¥é€šè¿‡"
        fi

  pr-size-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Check PR size
      run: |
        echo "ğŸ“ æ£€æŸ¥PRå¤§å°..."
        
        additions=${{ github.event.pull_request.additions }}
        deletions=${{ github.event.pull_request.deletions }}
        total_changes=$((additions + deletions))
        
        if [[ $total_changes -gt 1000 ]]; then
          echo "âš ï¸ PRå˜æ›´è¾ƒå¤§ ($total_changes è¡Œ)ï¼Œå»ºè®®æ‹†åˆ†ä¸ºæ›´å°çš„PR"
          echo "   - æ·»åŠ : $additions è¡Œ"
          echo "   - åˆ é™¤: $deletions è¡Œ"
        elif [[ $total_changes -gt 500 ]]; then
          echo "â„¹ï¸ PRå˜æ›´ä¸­ç­‰ ($total_changes è¡Œ)ï¼Œè¯·ç¡®ä¿å……åˆ†æµ‹è¯•"
        else
          echo "âœ… PRå¤§å°åˆé€‚ ($total_changes è¡Œ)"
        fi
