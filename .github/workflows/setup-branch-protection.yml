name: Setup Branch Protection

# è¿™ä¸ªå·¥ä½œæµç”¨äºŽè‡ªåŠ¨åŒ–è®¾ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™
# éœ€è¦ç®¡ç†å‘˜æƒé™å’ŒGITHUB_TOKENé…ç½®

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      branch_name:
        description: 'è¦ä¿æŠ¤çš„åˆ†æ”¯åç§°'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop
      protection_level:
        description: 'ä¿æŠ¤çº§åˆ«'
        required: true
        default: 'strict'
        type: choice
        options:
          - strict    # ä¸¥æ ¼ä¿æŠ¤ï¼ˆæŽ¨èç”¨äºŽä¸»åˆ†æ”¯ï¼‰
          - moderate  # ä¸­ç­‰ä¿æŠ¤ï¼ˆæŽ¨èç”¨äºŽå¼€å‘åˆ†æ”¯ï¼‰
          - basic     # åŸºç¡€ä¿æŠ¤

jobs:
  setup-protection:
    runs-on: ubuntu-latest
    if: github.actor == 'repository_owner' || contains(github.actor, 'admin')
    
    steps:
    - name: Setup Branch Protection Rules
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const branch = '${{ github.event.inputs.branch_name }}';
          const level = '${{ github.event.inputs.protection_level }}';
          
          console.log(`è®¾ç½®åˆ†æ”¯ ${branch} çš„ä¿æŠ¤è§„åˆ™ (çº§åˆ«: ${level})`);
          
          // åŸºç¡€æ£€æŸ¥åˆ—è¡¨
          let basicChecks = [
            'test',
            'security',
            'build-and-validate'
          ];
          
          // ä¸¥æ ¼æ£€æŸ¥åˆ—è¡¨  
          let strictChecks = [
            ...basicChecks,
            'documentation',
            'compatibility / ubuntu-latest (3.9)',
            'compatibility / ubuntu-latest (3.11)', 
            'compatibility / windows-latest (3.9)',
            'compatibility / windows-latest (3.11)',
            'compatibility / macos-latest (3.9)',
            'compatibility / macos-latest (3.11)',
            'validate-branch-protection',
            'check-required-files',
            'validate-codeowners'
          ];
          
          // æ ¹æ®ä¿æŠ¤çº§åˆ«é€‰æ‹©æ£€æŸ¥
          let requiredChecks;
          let reviewCount;
          let dismissStaleReviews;
          let requireCodeOwnerReviews;
          let restrictPushes;
          
          switch(level) {
            case 'strict':
              requiredChecks = strictChecks;
              reviewCount = 2;
              dismissStaleReviews = true;
              requireCodeOwnerReviews = true;
              restrictPushes = true;
              break;
            case 'moderate':
              requiredChecks = [...basicChecks, 'documentation'];
              reviewCount = 1;
              dismissStaleReviews = true;
              requireCodeOwnerReviews = false;
              restrictPushes = false;
              break;
            case 'basic':
              requiredChecks = basicChecks;
              reviewCount = 1;
              dismissStaleReviews = false;
              requireCodeOwnerReviews = false;
              restrictPushes = false;
              break;
          }
          
          // é…ç½®åˆ†æ”¯ä¿æŠ¤è§„åˆ™
          const protection = {
            required_status_checks: {
              strict: true,
              contexts: requiredChecks
            },
            enforce_admins: level === 'strict',
            required_pull_request_reviews: {
              required_approving_review_count: reviewCount,
              dismiss_stale_reviews: dismissStaleReviews,
              require_code_owner_reviews: requireCodeOwnerReviews,
              require_last_push_approval: level === 'strict'
            },
            restrictions: restrictPushes ? {
              users: [],
              teams: ['core-team', 'maintainers']
            } : null,
            required_conversation_resolution: level !== 'basic',
            block_creations: false
          };
          
          try {
            await github.rest.repos.updateBranchProtection({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: branch,
              ...protection
            });
            
            console.log(`âœ… æˆåŠŸè®¾ç½® ${branch} åˆ†æ”¯ä¿æŠ¤è§„åˆ™`);
            console.log(`   - ä¿æŠ¤çº§åˆ«: ${level}`);
            console.log(`   - å¿…éœ€å®¡æŸ¥: ${reviewCount} äºº`);
            console.log(`   - çŠ¶æ€æ£€æŸ¥: ${requiredChecks.length} é¡¹`);
            
          } catch (error) {
            console.error(`âŒ è®¾ç½®åˆ†æ”¯ä¿æŠ¤å¤±è´¥: ${error.message}`);
            throw error;
          }

  validate-setup:
    runs-on: ubuntu-latest
    needs: setup-protection
    
    steps:
    - name: Validate Protection Rules
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const branch = '${{ github.event.inputs.branch_name }}';
          
          try {
            const { data: protection } = await github.rest.repos.getBranchProtection({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: branch
            });
            
            console.log(`ðŸ” éªŒè¯ ${branch} åˆ†æ”¯ä¿æŠ¤è§„åˆ™:`);
            console.log(`   âœ… çŠ¶æ€æ£€æŸ¥å·²å¯ç”¨: ${protection.required_status_checks?.contexts?.length || 0} é¡¹`);
            console.log(`   âœ… PRå®¡æŸ¥è¦æ±‚: ${protection.required_pull_request_reviews?.required_approving_review_count || 0} äºº`);
            console.log(`   âœ… ç®¡ç†å‘˜å¼ºåˆ¶: ${protection.enforce_admins?.enabled ? 'æ˜¯' : 'å¦'}`);
            console.log(`   âœ… æ¸…é™¤è¿‡æ—¶å®¡æŸ¥: ${protection.required_pull_request_reviews?.dismiss_stale_reviews ? 'æ˜¯' : 'å¦'}`);
            
            // åˆ—å‡ºæ‰€æœ‰çŠ¶æ€æ£€æŸ¥
            if (protection.required_status_checks?.contexts?.length > 0) {
              console.log(`\nðŸ“‹ å¿…éœ€çŠ¶æ€æ£€æŸ¥:`);
              protection.required_status_checks.contexts.forEach(check => {
                console.log(`   - ${check}`);
              });
            }
            
          } catch (error) {
            console.error(`âŒ éªŒè¯åˆ†æ”¯ä¿æŠ¤å¤±è´¥: ${error.message}`);
            throw error;
          }

  generate-summary:
    runs-on: ubuntu-latest
    needs: [setup-protection, validate-setup]
    
    steps:
    - name: Generate Setup Summary
      run: |
        echo "# ðŸ”’ åˆ†æ”¯ä¿æŠ¤è®¾ç½®å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“‹ é…ç½®è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: \`${{ github.event.inputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¿æŠ¤çº§åˆ«**: \`${{ github.event.inputs.protection_level }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **é…ç½®æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **é…ç½®è€…**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âœ… ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        echo "1. éªŒè¯æ‰€æœ‰CIå·¥ä½œæµæ­£å¸¸è¿è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "2. æµ‹è¯•åˆ›å»ºPRä»¥ç¡®ä¿ä¿æŠ¤è§„åˆ™ç”Ÿæ•ˆ" >> $GITHUB_STEP_SUMMARY
        echo "3. é€šçŸ¥å›¢é˜Ÿæˆå‘˜æ–°çš„åˆ†æ”¯ä¿æŠ¤ç­–ç•¥" >> $GITHUB_STEP_SUMMARY
        echo "4. æ›´æ–°å¼€å‘æ–‡æ¡£å’Œè´¡çŒ®æŒ‡å—" >> $GITHUB_STEP_SUMMARY
